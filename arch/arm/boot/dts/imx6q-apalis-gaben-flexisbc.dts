/*
 * Copyright 2016 Gaben spol. s r.o.
 * Copyright 2011 Linaro Ltd.
 *
 * This file is dual-licensed: you can use it either under the terms
 * of the GPL or the X11 license, at your option. Note that this dual
 * licensing only applies to this file, and not this project as a
 * whole.
 *
 *  a) This file is free software; you can redistribute it and/or
 *     modify it under the terms of the GNU General Public License
 *     version 2 as published by the Free Software Foundation.
 *
 *     This file is distributed in the hope that it will be useful
 *     but WITHOUT ANY WARRANTY; without even the implied warranty of
 *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *     GNU General Public License for more details.
 *
 * Or, alternatively
 *
 *  b) Permission is hereby granted, free of charge, to any person
 *     obtaining a copy of this software and associated documentation
 *     files (the "Software"), to deal in the Software without
 *     restriction, including without limitation the rights to use
 *     copy, modify, merge, publish, distribute, sublicense, and/or
 *     sell copies of the Software, and to permit persons to whom the
 *     Software is furnished to do so, subject to the following
 *     conditions:
 *
 *     The above copyright notice and this permission notice shall be
 *     included in all copies or substantial portions of the Software.
 *
 *     THE SOFTWARE IS PROVIDED , WITHOUT WARRANTY OF ANY KIND
 *     EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 *     OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 *     NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 *     HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY
 *     WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 *     FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 *     OTHER DEALINGS IN THE SOFTWARE.
 */

/dts-v1/;

#include <dt-bindings/input/input.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include "imx6q.dtsi"
#include "imx6qdl-apalis.dtsi"

/ {
	model = "Toradex Apalis iMX6Q/D on Gaben Flexi SBC";
	compatible = "toradex,apalis_imx6q-gaben-flexisbc", "toradex,apalis_imx6q", "fsl,imx6q";

	aliases {
		i2c0 = &i2cddc;
		i2c1 = &i2c1;
		i2c2 = &i2c2;
		i2c3 = &i2c3;
	};

	aliases {
		rtc0 = &snvs_rtc;
	};

	gpio-keys {
		compatible = "gpio-keys";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_gpio_keys>;

		/* S1-S4 buttons on top board under LCD */
		S1 {
			label = "button-S1";
			gpios = <&gpio1 20 GPIO_ACTIVE_LOW>;
			linux,code = <BTN_A>;
			debounce-interval = <10>;
		};

		S2 {
			label = "button-S2";
			gpios = <&gpio2 2 GPIO_ACTIVE_LOW>;
			linux,code = <BTN_B>;
			debounce-interval = <10>;
		};

		S3 {
			label = "button-S3";
			gpios = <&gpio2 3 GPIO_ACTIVE_LOW>;
			linux,code = <BTN_C>;
			debounce-interval = <10>;
		};

		S4 {
			label = "button-S4";
			gpios = <&gpio1 16 GPIO_ACTIVE_LOW>;
			linux,code = <BTN_X>;
			debounce-interval = <10>;
		};

		/* IN0-IN3 digital inputs */
		IN0 {
			label = "dio-in0";
			gpios = <&gpio6 11 GPIO_ACTIVE_HIGH>;
			linux,code = <BTN_0>;
			debounce-interval = <10>;
		};

		IN1 {
			label = "dio-in1";
			gpios = <&gpio7 10 GPIO_ACTIVE_HIGH>;
			linux,code = <BTN_1>;
			debounce-interval = <10>;
		};

		IN2 {
			label = "dio-in2";
			gpios = <&gpio6 8 GPIO_ACTIVE_HIGH>;
			linux,code = <BTN_2>;
			debounce-interval = <10>;
		};

		IN3 {
			label = "dio-in3";
			gpios = <&gpio7 9 GPIO_ACTIVE_HIGH>;
			linux,code = <BTN_3>;
			debounce-interval = <10>;
		};
	};

	leds {
		compatible = "gpio-leds";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_gpio_leds>;

		heartbeat {
			label = "heartbeat";
			gpios = <&gpio3 22 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		rgb-r {
			label = "rgb-red";
			gpios = <&gpio4 18 GPIO_ACTIVE_LOW>;
			default-state = "off";
		};

		rgb-g {
			label = "rgb-green";
			gpios = <&gpio1 17 GPIO_ACTIVE_LOW>;
			default-state = "off";
		};

		rgb-b {
			label = "rgb-blue";
			gpios = <&gpio4 19 GPIO_ACTIVE_LOW>;
			default-state = "off";
		};

		led-in0 {
			label = "in0";
			gpios = <&gpio6 7 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		led-in1 {
			label = "in1";
			gpios = <&gpio6 16 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		led-in2 {
			label = "in2";
			gpios = <&gpio2 8 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		led-in3 {
			label = "in3";
			gpios = <&gpio2 11 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		/*
		 * TODO: For nodes bellow we're currently abusing LEDs, but we
		 * should fix it correctly with gpio-hog and automatic sysfs
		 * GPIO export so it could be used from userspace easily.
		 */

		relay0 {
			label = "relay0";
			gpios = <&gpio4 5 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		relay1 {
			label = "relay1";
			gpios = <&gpio5 11 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		relay2 {
			label = "relay2";
			gpios = <&gpio2 27 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		relay3 {
			label = "relay3";
			gpios = <&gpio5 10 GPIO_ACTIVE_HIGH>;
			default-state = "off";
		};

		/* USB HUB CY7C65632 reset, not connected currently */
		reset-usb-hub2 {
			label = "reset-usb-hub2";
			gpios = <&gpio6 15 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		/* adv7180@i2c3 reset */
		reset-adv7180 {
			label = "reset-adv7180";
			gpios = <&gpio7 12 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		power-enable-gsm {
			label = "power-enable-gsm";
			gpios = <&gpio_expander 0 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		power-enable-custom {
			label = "power-enable-custom";
			gpios = <&gpio_expander 1 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		/* adv7180@i2c3 power enable */
		power-enable-adv7180 {
			label = "power-enable-adv7180";
			gpios = <&gpio_expander 2 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		power-enable-pcie {
			label = "power-enable-pcie";
			gpios = <&gpio_expander 3 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};

		power-enable-misc {
			label = "power-enable-misc";
			gpios = <&gpio_expander 4 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};
	};

	pwmleds {
		compatible = "pwm-leds";
		ledpwm1 {
			label = "pwm-lcd";
			pwms = <&pwm1 0 50000>;
			max-brightness = <255>;
		};

		ledpwm2 {
			label = "pwm-beeper";
			pwms = <&pwm2 0 488281>;
			max-brightness = <255>;
		};

		ledpwm3 {
			label = "pwm-lvds";
			pwms = <&pwm3 0 50000>;
			max-brightness = <255>;
		};
	};

	reg_usb_otg_vbus: usb_otg_vbus {
		status = "okay";

		compatible = "regulator-fixed";
		regulator-name = "usb_otg_vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		regulator-always-on;
	};

	reg_usb_host_vbus: usb_host_vbus {
		status = "okay";
	};
};

&can1 {
	status = "okay";
};

&gpio3 {
	/* mcp23009@i2c3 reset */
	expander-reset {
		gpio-hog;
		gpios = <29 GPIO_ACTIVE_HIGH>;
		output-high;
		line-name = "expander-reset";
	};
};

&i2c1 {
	status = "okay";

	sensor: lm75@48 {
		compatible = "national,lm75";
		reg = <0x48>;
	};
};

&i2c3 {
	status = "okay";

	gpio_expander: mcp23009@20 {
		compatible = "microchip,mcp23008";
		gpio-controller;
		#gpio-cells = <2>;
		reg = <0x20>;
	};

	adv7180: adv7180@21 {
		compatible = "adv,adv7180";
		reg = <0x21>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_ipu1_csi0>;
		clocks = <&clks 200>;
		clock-names = "csi_mclk";
		DOVDD-supply = <&reg_3p3v>; /* 3.3v */
		AVDD-supply = <&reg_3p3v>;  /* 1.8v */
		DVDD-supply = <&reg_3p3v>;  /* 1.8v */
		PVDD-supply = <&reg_3p3v>;  /* 1.8v */
		csi_id = <0>;
		mclk = <24000000>;
		mclk_source = <1>;
		cvbs = <1>;
		status = "okay";
	};
};

&iomuxc {
	/*
	 * Mux the Apalis GPIOs, GPIO7 used for PCIe reset,
	 * GPIO5, 6 used by optional fusion_F0710A kernel module
	 */
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_apalis_gpio1 &pinctrl_apalis_gpio2
		     &pinctrl_apalis_gpio3 &pinctrl_apalis_gpio4
		     &pinctrl_apalis_gpio5 &pinctrl_apalis_gpio6
		     &pinctrl_apalis_gpio7 &pinctrl_apalis_gpio8
		     &pinctrl_rs485_dr &pinctrl_misc_gpio>;

	gpio {
		pinctrl_gpio_keys: gpio_keys {
			fsl,pins = <
				MX6QDL_PAD_SD1_CLK__GPIO1_IO20		0x1b0b0	/* BTN0 */
				MX6QDL_PAD_NANDF_D2__GPIO2_IO02		0x1b0b0 /* BTN1 */
				MX6QDL_PAD_NANDF_D3__GPIO2_IO03		0x1b0b0 /* BTN2 */
				MX6QDL_PAD_SD1_DAT0__GPIO1_IO16		0x1b0b0 /* BTN3 */
				>;
		};

		pinctrl_rs485_dr: rs_485_dr {
			fsl,pins = <
				MX6QDL_PAD_EIM_WAIT__GPIO5_IO00		0x130b0	/* 485-DR */
				>;
		};

		pinctrl_misc_gpio: misc_gpio {
			fsl,pins = <
				MX6QDL_PAD_EIM_DA14__GPIO3_IO14		0x130b0 /* LVDS-BLK_PWM */
				MX6QDL_PAD_SD1_DAT2__GPIO1_IO19		0x130b0 /* CS_PCIE */
				MX6QDL_PAD_SD1_DAT3__GPIO1_IO21		0x130b0	/* RING */
				MX6QDL_PAD_NANDF_D0__GPIO2_IO00		0x130b0	/* WDIS */
				MX6QDL_PAD_SD1_CMD__GPIO1_IO18		0x130b0	/* PERST */
				MX6QDL_PAD_NANDF_CS2__GPIO6_IO15	0x130b0 /* RHUB */
				>;
		};

		pinctrl_gpio_leds: gpio_leds {
			fsl,pins = <
				MX6QDL_PAD_EIM_D22__GPIO3_IO22 		0x130b0 /* Heartbeat LED */

				MX6QDL_PAD_DI0_PIN2__GPIO4_IO18		0x1b0b0	/* RGB-R */
				MX6QDL_PAD_SD1_DAT1__GPIO1_IO17		0x1b0b0	/* RGB-G */
				MX6QDL_PAD_DI0_PIN3__GPIO4_IO19		0x1b0b0	/* RGB-B */

				MX6QDL_PAD_NANDF_CLE__GPIO6_IO07	0x130b0	/* LED-IN0 */
				MX6QDL_PAD_NANDF_CS3__GPIO6_IO16	0x130b0 /* LED-IN1 */
				MX6QDL_PAD_SD4_DAT0__GPIO2_IO08		0x130b0	/* LED-IN2 */
				MX6QDL_PAD_SD4_DAT3__GPIO2_IO11		0x130b0	/* LED-IN3 */

				MX6QDL_PAD_GPIO_19__GPIO4_IO05		0x130b0	/* RELAY0 */
				MX6QDL_PAD_DISP0_DAT17__GPIO5_IO11	0x130b0	/* RELAY1 */
				MX6QDL_PAD_EIM_LBA__GPIO2_IO27		0x130b0	/* RELAY2 */
				MX6QDL_PAD_DISP0_DAT16__GPIO5_IO10	0x130b0	/* RELAY3 */
				>;
		};
	};

	usbotg {
		pinctrl_usbotg: usbotggrp {
			fsl,pins = <
				MX6QDL_PAD_ENET_RX_ER__USB_OTG_ID 0x17059
			>;
		};
	};

	usdhc {
		/* GPIO4_IO20 is LVDS */
		pinctrl_mmc_cd: gpio_mmc_cd {
		};

		/* Used as misc GPIOs */
		pinctrl_usdhc1: usdhc1grp {
		};
	};
};

&ldb {
	status = "disabled";
};

&sata {
	status = "disabled";
};

&pcie {
	reset-gpio = <&gpio1 28 GPIO_ACTIVE_LOW>;
	status = "okay";
};

&pwm1 {
	status = "okay";
};

&pwm2 {
	status = "okay";
};

&pwm3 {
	status = "okay";
};

&pwm4 {
	status = "okay";
};

&uart1 {
	status = "okay";
};

&uart2 {
	status = "okay";
};

&uart4 {
	status = "okay";
};

&uart5 {
	status = "okay";
};

&usbh1 {
	status = "okay";
};

&usbotg {
	vbus-supply = <&reg_usb_otg_vbus>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_usbotg>;
	disable-over-current;
	status = "okay";
};

/* SD1 */
&usdhc2 {
	status = "okay";
};
